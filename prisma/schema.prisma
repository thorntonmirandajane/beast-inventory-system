generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String            @id @default(cuid())
  email                  String            @unique
  password               String
  firstName              String
  lastName               String
  isActive               Boolean           @default(true)
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  role                   UserRole          @default(WORKER)
  payRate                Float?
  auditLogs              AuditLog[]
  clockEvents            ClockEvent[]
  purchaseOrdersApproved PurchaseOrder[]   @relation("POApprovedBy")
  purchaseOrdersCreated  PurchaseOrder[]   @relation("POCreatedBy")
  receivingCreated       ReceivingRecord[] @relation("CreatedBy")
  receivingSignOffs      ReceivingRecord[] @relation("SignedOffBy")
  transfers              Transfer[]
  workOrders             WorkOrder[]
  schedules              WorkerSchedule[]
  assignedTasks          WorkerTask[]      @relation("AssignedTasks")
  workerTasks            WorkerTask[]      @relation("WorkerTasks")
  approvedEntries        WorkerTimeEntry[] @relation("ApprovedEntries")
  timeEntries            WorkerTimeEntry[]

  @@map("users")
}

model ClockEvent {
  id            String           @id @default(cuid())
  userId        String
  type          ClockEventType
  timestamp     DateTime         @default(now())
  notes         String?
  user          User             @relation(fields: [userId], references: [id])
  clockInEntry  WorkerTimeEntry? @relation("ClockIn")
  clockOutEntry WorkerTimeEntry? @relation("ClockOut")

  @@index([userId, timestamp])
  @@map("clock_events")
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  userId    String
  message   String
  metadata  String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([isRead, createdAt])
  @@map("notifications")
}

model Sku {
  id                  String            @id @default(cuid())
  sku                 String            @unique
  name                String
  type                SkuType
  description         String?
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  category            String?
  material            String?
  upc                 String?
  usedInBoms          BomComponent[]    @relation("ComponentSku")
  bomComponents       BomComponent[]    @relation("ParentSku")
  inventoryItems      InventoryItem[]
  poItems             POItem[]
  processTimes        ProcessTime[]
  receivingRecords    ReceivingRecord[]
  manufacturers       SkuManufacturer[]
  timeEntryLines      TimeEntryLine[]   @relation("TimeEntryLineSku")
  transferItems       TransferItem[]
  workOrdersProducing WorkOrder[]       @relation("OutputSku")
  workerTasks         WorkerTask[]      @relation("TaskSku")

  @@map("skus")
}

model BomComponent {
  id             String @id @default(cuid())
  parentSkuId    String
  componentSkuId String
  quantity       Int
  componentSku   Sku    @relation("ComponentSku", fields: [componentSkuId], references: [id])
  parentSku      Sku    @relation("ParentSku", fields: [parentSkuId], references: [id])

  @@unique([parentSkuId, componentSkuId])
  @@index([parentSkuId])
  @@index([componentSkuId])
  @@map("bom_components")
}

model InventoryItem {
  id        String         @id @default(cuid())
  skuId     String
  quantity  Int
  state     InventoryState
  location  String?
  notes     String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  sku       Sku            @relation(fields: [skuId], references: [id])

  @@index([skuId, state])
  @@map("inventory_items")
}

model PurchaseOrder {
  id               String    @id @default(cuid())
  poNumber         String    @unique
  vendorName       String
  status           POStatus  @default(SUBMITTED)
  submittedAt      DateTime  @default(now())
  estimatedArrival DateTime?
  receivedAt       DateTime?
  createdById      String
  approvedById     String?
  approvedAt       DateTime?
  notes            String?
  items            POItem[]
  approvedBy       User?     @relation("POApprovedBy", fields: [approvedById], references: [id])
  createdBy        User      @relation("POCreatedBy", fields: [createdById], references: [id])

  @@index([status])
  @@index([poNumber])
  @@map("purchase_orders")
}

model POItem {
  id               String        @id @default(cuid())
  purchaseOrderId  String
  skuId            String
  quantityOrdered  Int
  quantityReceived Int           @default(0)
  notes            String?
  manufacturerId   String?
  manufacturer     Manufacturer? @relation(fields: [manufacturerId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  sku              Sku           @relation(fields: [skuId], references: [id])

  @@index([purchaseOrderId])
  @@map("po_items")
}

model ReceivingRecord {
  id            String          @id @default(cuid())
  skuId         String
  quantity      Int
  receivedAt    DateTime        @default(now())
  createdById   String
  signedOffById String?
  signedOffAt   DateTime?
  status        ReceivingStatus @default(PENDING)
  poNumber      String?
  vendorName    String?
  notes         String?
  createdBy     User            @relation("CreatedBy", fields: [createdById], references: [id])
  signedOffBy   User?           @relation("SignedOffBy", fields: [signedOffById], references: [id])
  sku           Sku             @relation(fields: [skuId], references: [id])

  @@index([status])
  @@index([skuId])
  @@map("receiving_records")
}

model WorkOrder {
  id              String                 @id @default(cuid())
  orderNumber     String                 @unique @default(cuid())
  outputSkuId     String
  quantityToBuild Int
  quantityBuilt   Int                    @default(0)
  status          WorkOrderStatus        @default(PENDING)
  createdById     String
  createdAt       DateTime               @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  notes           String?
  consumptions    WorkOrderConsumption[]
  createdBy       User                   @relation(fields: [createdById], references: [id])
  outputSku       Sku                    @relation("OutputSku", fields: [outputSkuId], references: [id])

  @@index([status])
  @@index([outputSkuId])
  @@map("work_orders")
}

model WorkOrderConsumption {
  id          String    @id @default(cuid())
  workOrderId String
  skuId       String
  quantity    Int
  consumedAt  DateTime  @default(now())
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])

  @@index([workOrderId])
  @@map("work_order_consumptions")
}

model Transfer {
  id             String         @id @default(cuid())
  transferNumber String         @unique @default(cuid())
  destination    String
  shippedAt      DateTime       @default(now())
  createdById    String
  trackingNumber String?
  carrier        String?
  notes          String?
  items          TransferItem[]
  createdBy      User           @relation(fields: [createdById], references: [id])

  @@index([destination])
  @@map("transfers")
}

model TransferItem {
  id         String   @id @default(cuid())
  transferId String
  skuId      String
  quantity   Int
  sku        Sku      @relation(fields: [skuId], references: [id])
  transfer   Transfer @relation(fields: [transferId], references: [id])

  @@index([transferId])
  @@map("transfer_items")
}

model WorkerSchedule {
  id           String       @id @default(cuid())
  userId       String
  dayOfWeek    Int?         // 0=Sunday, 1=Monday, etc. (null for specific dates)
  scheduleDate DateTime?    // Specific date for one-time schedules
  scheduleType ScheduleType @default(RECURRING)
  startTime    String
  endTime      String
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  user         User         @relation(fields: [userId], references: [id])

  @@unique([userId, dayOfWeek, scheduleDate])
  @@index([userId])
  @@index([scheduleDate])
  @@map("worker_schedules")
}

model ProcessConfig {
  id             String          @id @default(cuid())
  processName    String          @unique
  displayName    String
  description    String?
  secondsPerUnit Int
  isActive       Boolean         @default(true)
  consumesState  InventoryState?
  producesState  InventoryState?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("process_configs")
}

model ProcessTutorial {
  id            String                  @id @default(cuid())
  processName   String
  title         String
  description   String                  @db.Text
  photoUrl      String?
  isActive      Boolean                 @default(true)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  skuTutorials  ProcessTutorialSku[]

  @@index([processName])
  @@map("process_tutorials")
}

model ProcessTutorialSku {
  id                 String           @id @default(cuid())
  processTutorialId  String
  skuId              String
  tutorial           ProcessTutorial  @relation(fields: [processTutorialId], references: [id], onDelete: Cascade)

  @@unique([processTutorialId, skuId])
  @@index([skuId])
  @@map("process_tutorial_skus")
}

model Forecast {
  id                  String   @id @default(cuid())
  skuId               String
  quantity            Int
  currentInGallatin   Int      @default(0)
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([skuId])
  @@index([skuId])
  @@map("forecasts")
}

model ProcessTime {
  id             String @id @default(cuid())
  skuId          String
  processType    String
  minutesPerUnit Float
  sku            Sku    @relation(fields: [skuId], references: [id])

  @@unique([skuId, processType])
  @@index([skuId])
  @@map("process_times")
}

model Manufacturer {
  id               String            @id @default(cuid())
  name             String            @unique
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  poItems          POItem[]
  skuManufacturers SkuManufacturer[]

  @@map("manufacturers")
}

model SkuManufacturer {
  id             String       @id @default(cuid())
  skuId          String
  manufacturerId String
  cost           Float?
  leadTimeDays   Int?
  isPreferred    Boolean      @default(false)
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id])
  sku            Sku          @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@unique([skuId, manufacturerId])
  @@index([skuId])
  @@index([manufacturerId])
  @@map("sku_manufacturers")
}

model WorkerTask {
  id             String             @id @default(cuid())
  userId         String
  processName    String
  skuId          String?
  targetQuantity Int?
  priority       Int                @default(0)
  assignmentType TaskAssignmentType @default(DAILY)
  status         TaskStatus         @default(PENDING)
  assignedById   String
  dueDate        DateTime?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  completedAt    DateTime?
  timeEntryLines TimeEntryLine[]
  assignedBy     User               @relation("AssignedTasks", fields: [assignedById], references: [id])
  sku            Sku?               @relation("TaskSku", fields: [skuId], references: [id])
  user           User               @relation("WorkerTasks", fields: [userId], references: [id])

  @@index([userId, status])
  @@index([dueDate])
  @@map("worker_tasks")
}

model WorkerTimeEntry {
  id              String          @id @default(cuid())
  userId          String
  clockInEventId  String          @unique
  clockOutEventId String?         @unique
  clockInTime     DateTime
  clockOutTime    DateTime?
  breakMinutes    Int             @default(0)
  actualMinutes   Int?
  expectedMinutes Float?
  efficiency      Float?
  status          TimeEntryStatus @default(DRAFT)
  approvedById    String?
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  rejectionPhoto  String?
  lines           TimeEntryLine[]
  approvedBy      User?           @relation("ApprovedEntries", fields: [approvedById], references: [id])
  clockInEvent    ClockEvent      @relation("ClockIn", fields: [clockInEventId], references: [id])
  clockOutEvent   ClockEvent?     @relation("ClockOut", fields: [clockOutEventId], references: [id])
  user            User            @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@index([clockInTime])
  @@map("worker_time_entries")
}

model TimeEntryLine {
  id                    String          @id @default(cuid())
  timeEntryId           String
  processName           String
  skuId                 String?
  quantityCompleted     Int
  secondsPerUnit        Int
  expectedSeconds       Int
  workerTaskId          String?
  notes                 String?
  adminAdjustedQuantity Int?
  adminNotes            String?
  isRejected            Boolean         @default(false)
  rejectionReason       String?
  rejectionQuantity     Int?
  isMisc                Boolean         @default(false)
  miscDescription       String?
  createdAt             DateTime        @default(now())
  sku                   Sku?            @relation("TimeEntryLineSku", fields: [skuId], references: [id])
  timeEntry             WorkerTimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  workerTask            WorkerTask?     @relation(fields: [workerTaskId], references: [id])

  @@index([timeEntryId])
  @@map("time_entry_lines")
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  action       String
  resourceType String
  resourceId   String
  details      Json?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  ADMIN
  WORKER
}

enum ClockEventType {
  CLOCK_IN
  CLOCK_OUT
  BREAK_START
  BREAK_END
}

enum NotificationType {
  LATE_CLOCK_IN
  MISSED_CLOCK_IN
  MISSED_CLOCK_OUT
}

enum SkuType {
  RAW
  ASSEMBLY
  COMPLETED
}

enum InventoryState {
  RECEIVED
  RAW
  ASSEMBLED
  COMPLETED
  TRANSFERRED
}

enum POStatus {
  SUBMITTED
  PARTIAL
  RECEIVED
  APPROVED
  CANCELLED
}

enum ReceivingStatus {
  PENDING
  APPROVED
  REJECTED
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskAssignmentType {
  DAILY
  BACKLOG
}

enum TaskStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum TimeEntryStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum ScheduleType {
  RECURRING
  SPECIFIC_DATE
}
